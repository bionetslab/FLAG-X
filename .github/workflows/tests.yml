name: Tests

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash -l {0}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # -------------------- Micromamba setup --------------------
      # This replaces Miniconda but uses your SAME environment.yml
      - name: Set up micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-file: environment.yml
          environment-name: test-env
          cache-environment: true
          init-shell: bash
          condarc: |
            channels:
              - conda-forge
            channel_priority: strict

      # Ensure environment is active
      - name: Activate micromamba environment
        run: |
          micromamba activate test-env
          echo "Environment activated"

      # -------------------- Space cleanup --------------------
      - name: Clean conda/mamba/pip caches
        run: |
          micromamba activate test-env
          micromamba clean --all --yes
          pip cache purge || true

      # -------------------- Test dependencies --------------------
      - name: Install test dependencies
        run: |
          micromamba activate test-env
          conda install pytest pytest-cov -y
          micromamba clean --all --yes

      # -------------------- Install flagx --------------------
      - name: Install FLAG-X package
        run: |
          micromamba activate test-env
          pip install -e .

      # -------------------- Run Tests --------------------
      - name: Run tests with coverage
        run: |
          micromamba activate test-env
          pytest --cov=. --cov-report=xml --cov-report=term

      # -------------------- Ensure badges folder exists --------------------
      - name: Ensure badges directory exists
        run: mkdir -p ${{ github.workspace }}/badges

      # -------------------- Badges --------------------
      - name: Generate passing test badge
        uses: emibcn/badge-action@v1.2.1
        if: ${{ success() }}
        with:
          label: "tests"
          status: "passing"
          color: "green"
          path: "${{ github.workspace }}/badges/test-status.svg"

      - name: Generate failing test badge
        uses: emibcn/badge-action@v1.2.1
        if: ${{ failure() }}
        with:
          label: "tests"
          status: "failing"
          color: "red"
          path: "${{ github.workspace }}/badges/test-status.svg"

      - name: Extract coverage percentage
        id: coverage
        run: |
          value=$(xmllint --xpath "string(/coverage/@line-rate)" coverage.xml)
          percent=$(printf "%.0f" "$(echo "$value * 100" | bc)")
          echo "percent=$percent" >> $GITHUB_OUTPUT

      - name: Generate coverage badge
        uses: emibcn/badge-action@v1.2.1
        with:
          label: "coverage"
          status: "${{ steps.coverage.outputs.percent }}%"
          color: "blue"
          path: "${{ github.workspace }}/badges/coverage.svg"

      - name: Commit badges
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Update test & coverage badges"
          file_pattern: "badges/*.svg"
